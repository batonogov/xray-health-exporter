name: ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Pull Request

on:
  push:
    branches:
      - "*"
      - "!main"

jobs:
  pull-request:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üìä –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: analyze
        run: |
          # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ç–∫–µ
          BRANCH_NAME="${{ github.ref_name }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–º–∏—Ç–æ–≤
          COMMIT_COUNT=$(git rev-list --count HEAD ^origin/main)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∞–π–ª–æ–≤
          FILES_CHANGED=$(git diff --name-only origin/main...HEAD | wc -l)
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

          # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç—Ä–æ–∫
          STATS=$(git diff --shortstat origin/main...HEAD)
          echo "stats=$STATS" >> $GITHUB_OUTPUT

          # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 20)
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | head -20 | sed 's/^/- `/' | sed 's/$/`/')
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤
          COMMITS=$(git log --oneline origin/main...HEAD --format="- %s (%h)" | head -10)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–µ
          AUTHOR=$(git log -1 --format="%an")
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head ${{ github.ref_name }} --base main --json number --jq '.[0].number // empty')

          if [ -n "$PR_NUMBER" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR #$PR_NUMBER"
            echo "exists=true" >> $GITHUB_OUTPUT
            PR_URL=$(gh pr view $PR_NUMBER --json url -q .url)
            echo "url=$PR_URL" >> $GITHUB_OUTPUT
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" = "true" ]; then
            echo "‚úÖ PR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è—é..."
            PR_NUM="${{ steps.check_pr.outputs.number }}"

            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–ª–∞ PR
            echo "## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Pull Request" > pr_body.md
            echo "" >> pr_body.md
            echo "> **–í–µ—Ç–∫–∞:** \`${{ steps.analyze.outputs.branch_name }}\`" >> pr_body.md
            echo "> **–ê–≤—Ç–æ—Ä:** ${{ steps.analyze.outputs.author }}" >> pr_body.md
            echo "" >> pr_body.md
            echo "### üìä –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π" >> pr_body.md
            echo "- **–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** ${{ steps.analyze.outputs.files_changed }}" >> pr_body.md
            echo "- **–ö–æ–º–º–∏—Ç–æ–≤:** ${{ steps.analyze.outputs.commit_count }}" >> pr_body.md
            echo "- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** ${{ steps.analyze.outputs.stats }}" >> pr_body.md
            echo "" >> pr_body.md
            echo "### üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã" >> pr_body.md
            echo '${{ steps.analyze.outputs.commits }}' >> pr_body.md
            echo "" >> pr_body.md
            echo "### üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã" >> pr_body.md
            echo "<details>" >> pr_body.md
            echo "<summary>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</summary>" >> pr_body.md
            echo "" >> pr_body.md
            echo '${{ steps.analyze.outputs.changed_files }}' >> pr_body.md
            echo "" >> pr_body.md
            echo "</details>" >> pr_body.md
            echo "" >> pr_body.md
            echo "---" >> pr_body.md
            echo "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ GitHub Actions" >> pr_body.md

            gh pr edit $PR_NUM --body-file pr_body.md
          else
            echo "üÜï –°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π PR..."

            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–ª–∞ PR
            echo "## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Pull Request" > pr_body.md
            echo "" >> pr_body.md
            echo "> **–í–µ—Ç–∫–∞:** \`${{ steps.analyze.outputs.branch_name }}\`" >> pr_body.md
            echo "> **–ê–≤—Ç–æ—Ä:** ${{ steps.analyze.outputs.author }}" >> pr_body.md
            echo "" >> pr_body.md
            echo "### üìä –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π" >> pr_body.md
            echo "- **–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** ${{ steps.analyze.outputs.files_changed }}" >> pr_body.md
            echo "- **–ö–æ–º–º–∏—Ç–æ–≤:** ${{ steps.analyze.outputs.commit_count }}" >> pr_body.md
            echo "- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** ${{ steps.analyze.outputs.stats }}" >> pr_body.md
            echo "" >> pr_body.md
            echo "### üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã" >> pr_body.md
            echo '${{ steps.analyze.outputs.commits }}' >> pr_body.md
            echo "" >> pr_body.md
            echo "### üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã" >> pr_body.md
            echo "<details>" >> pr_body.md
            echo "<summary>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</summary>" >> pr_body.md
            echo "" >> pr_body.md
            echo '${{ steps.analyze.outputs.changed_files }}' >> pr_body.md
            echo "" >> pr_body.md
            echo "</details>" >> pr_body.md
            echo "" >> pr_body.md
            echo "---" >> pr_body.md
            echo "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ GitHub Actions" >> pr_body.md

            gh pr create \
              --title "üöÄ –ê–≤—Ç–æ PR: ${{ steps.analyze.outputs.branch_name }}" \
              --body-file pr_body.md \
              --base main \
              --head ${{ github.ref_name }} || echo "‚ö†Ô∏è PR –≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          fi

      - name: üì¢ –ò—Ç–æ–≥–∏
        run: |
          echo "## üìã –ò—Ç–æ–≥–∏" >> $GITHUB_STEP_SUMMARY
          echo "- **–í–µ—Ç–∫–∞:** ${{ steps.analyze.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **–§–∞–π–ª–æ–≤:** ${{ steps.analyze.outputs.files_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **–ö–æ–º–º–∏—Ç–æ–≤:** ${{ steps.analyze.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **–ê–≤—Ç–æ—Ä:** ${{ steps.analyze.outputs.author }}" >> $GITHUB_STEP_SUMMARY

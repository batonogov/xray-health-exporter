version: "3"

tasks:
  build:
    desc: –°–æ–±—Ä–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª
    cmds:
      - go build -o xray-health-exporter .

  test:
    desc: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
    cmds:
      - go test -v -cover ./...

  test-race:
    desc: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º –≥–æ–Ω–æ–∫
    cmds:
      - go test -v -race ./...

  test-coverage:
    desc: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
    cmds:
      - go test -coverprofile=coverage.out ./...
      - go tool cover -func=coverage.out
      - >
        echo "üìä –î–ª—è HTML –æ—Ç—á–µ—Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: go tool cover -html=coverage.out"

  coverage-html:
    desc: –û—Ç–∫—Ä—ã—Ç—å HTML –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
    deps: [test-coverage]
    cmds:
      - go tool cover -html=coverage.out

  ci-test:
    desc: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∫–∞–∫ –≤ CI (—Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∏ race detector)
    cmds:
      - go fmt ./...
      - go build -v -o xray-health-exporter .
      - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      - go tool cover -func=coverage.out | tail -1
      - echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ CI –ø—Ä–æ–π–¥–µ–Ω—ã!"

  install-hooks:
    desc: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å git pre-commit —Ö—É–∫–∏
    cmds:
      - pre-commit install
      - echo "‚úÖ Pre-commit —Ö—É–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"

  update-deps:
    desc: –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ Go –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏–π
    cmds:
      - go get -u ./...
      - go mod tidy
      - echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!"

  update-deps-minor:
    desc: –û–±–Ω–æ–≤–∏—Ç—å Go –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –º–∏–Ω–æ—Ä–Ω—ã—Ö –≤–µ—Ä—Å–∏–π
    cmds:
      - go get -u=patch ./...
      - go mod tidy
      - echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –ø–∞—Ç—á–∏)!"

  tidy:
    desc: –ü—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ go.mod –∏ go.sum
    cmds:
      - go mod tidy
      - echo "‚úÖ go.mod –ø—Ä–∏–≤–µ–¥–µ–Ω –≤ –ø–æ—Ä—è–¥–æ–∫!"

  clean:
    desc: –û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏
    cmds:
      - rm -f xray-health-exporter coverage.txt

  run:
    desc: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    cmds:
      - go run .

  docker-build:
    desc: –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
    cmds:
      - docker build -t xray-health-exporter .

  docker-build-multi:
    desc: –°–æ–±—Ä–∞—Ç—å –º—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π Docker –æ–±—Ä–∞–∑
    cmds:
      - docker buildx build --platform linux/amd64,linux/arm64 -t xray-health-exporter .

  docker-run:
    desc: –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    deps: [docker-build]
    cmds:
      - docker run --rm -v $(pwd)/config.yaml:/app/config.yaml:ro -p 9273:9273 xray-health-exporter
